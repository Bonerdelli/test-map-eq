"use strict";var app=function(e,t,a){var o=function(){this.loader=e,this.doc=t,this.log=a};return o.prototype.extend=function n(e,t){e=e||{};for(var a in t)t.hasOwnProperty(a)&&("object"==typeof t[a]?e[a]=n(e[a],t[a]):"undefined"!=typeof t[a]&&(e[a]=t[a]));return e},o.prototype.clone=function(e){return JSON.parse(JSON.stringify(e))},new o}(loader,document,console);app.loader.onReady("map",function(){this.initialize()}),app.loader.onReady("dateSelector",function(){this.initialize()}),define("earthquake",["promise","moment","message"],function(e,t,a){var o={apiUrl:"http://earthquake.usgs.gov/fdsnws/event/1/query",defaultQueryOptions:{format:"geojson",eventtype:"earthquake",starttime:t().subtract(1,"week").format("YYYY-MM-DD"),endtime:t().format("YYYY-MM-DD")}},n=function(e){this.data=null,this.options=e,this.callbacks={}};return n.prototype.query=function(t){var o=this,n={},s=this.options.apiUrl,r=new e.Promise;return this._execCallbacks("beforeQuery"),t=t||{},app.extend(n,this.options.defaultQueryOptions),app.extend(n,t),e.get(s,n).then(function(e,t,n){if(e)app.log.error("Error requesting features data",n.status),a.set("произошла ошибка загрузки данных","error");else try{o.data=JSON.parse(t)}catch(s){app.log.error("Error parsing features data",s),a.set("произошла ошибка обработки данных","error")}o._execCallbacks("afterQuery"),r.done(o.data)}),r},n.prototype.clean=function(){this._execCallbacks("afterClean"),this.data=null},n.prototype.on=function(e,t){void 0===this.callbacks[e]?this.callbacks[e]=[t]:this.callbacks[e].push(t)},n.prototype._execCallbacks=function(e){var t=this.data;this.callbacks[e]&&this.callbacks[e].length&&this.callbacks[e].forEach(function(e){e(t)})},new n(o)}),define("map",["L","HeatmapOverlay","earthquake","moment","message"],function(e,t,a,o,n){var s={mapElementId:"map",mapBox:{accessToken:"pk.eyJ1IjoiYm9uZXJkZWxsaSIsImEiOiJjaWlsY2d5MzYwMDVjdm5tMDhta2N6cXBoIn0.rC98OHIqnN3oQiSnoSKp2g",styleBaseUrl:"https://api.mapbox.com/styles/v1/mapbox/dark-v9"},defaultPosition:{lon:37.8,lat:-96,zoom:4},pointMarkerStyle:{radius:2,fillColor:"#fff",color:"#fff",weight:2,opacity:.2,fillOpacity:1},heatMap:{radius:2,maxOpacity:.5,scaleRadius:!0,useLocalExtrema:!1,valueField:"mag",gradient:{.25:"#05f",.4:"#0f3",.75:"#ff0",.98:"#f00"}}},r=function(e){this.options=e,this.heatmapLayer=null,this.pointsLayer=null,this.map=null};return r.prototype.initialize=function(){var o=this,n=e.map(s.mapElementId);this.map=n,n.setView([s.defaultPosition.lon,s.defaultPosition.lat],s.defaultPosition.zoom),e.tileLayer(s.mapBox.styleBaseUrl+"/tiles/256/{z}/{x}/{y}?access_token="+s.mapBox.accessToken,{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a>'}).addTo(n);var r=new t(s.heatMap).addTo(n),i=e.geoJSON(void 0,{pointToLayer:function(t,a){return e.circleMarker(a,s.pointMarkerStyle)},onEachFeature:function(e,t){var a=o.renderFeaturePopup(e);t.bindPopup(a)}}).addTo(n);return a.on("afterQuery",function(e){e&&e.features&&e.features.length?(app.log.info("Retrieved features count:",e.features.length),o.setData(e)):o.cleanData()}),a.on("afterClean",function(){o.cleanData()}),this.heatmapLayer=r,this.pointsLayer=i,!0},r.prototype.renderFeaturePopup=function(e){for(var t='<dl class="data-list">',a=e.properties,n=[{title:"Магнитуда",value:"<strong>"+a.mag+"</strong>"},{title:"Код события",value:'<a href="'+a.url+'" target="_blank">'+a.code+"</a>"},{title:"Дата и время",value:o(a.time).format("LLL")},{title:"Место",value:a.place}],s=0;s<n.length;s++)t+="<dt>"+(n[s].title||"&nbsp;")+"</dt><dd>"+n[s].value+"</dd>";return t+="<dl>"},r.prototype.setData=function(e){var t=[];this.pointsLayer.addData(e);for(var a=0;a<e.features.length;a++){var o=e.features[a];o.geometry&&"Point"===o.geometry.type&&o.properties.mag&&t.push({lat:o.geometry.coordinates[1],lng:o.geometry.coordinates[0],mag:o.properties.mag})}t&&t.length?this.heatmapLayer.setData({data:t,max:10,min:0}):this.heatmapLayer.setData([])},r.prototype.cleanData=function(){this.pointsLayer.clearLayers(),this.heatmapLayer.setData({data:[]})},new r(s)}),define("dateSelector",["Pikaday","earthquake","message","moment"],function(e,t,a,o){var n={maxPeriod:30,formElementId:"dateSelectorForm",dateValueFormat:"YYYY-MM-DD",dateDisplayFormat:"LL",dateFields:[{name:"dateFrom",fieldName:"datefrom",defaultValue:o().subtract(1,"week")},{name:"dateTo",fieldName:"dateto",defaultValue:o()}],pikaday:{format:"LL",maxDate:o().toDate(),firstDay:1,i18n:{previousMonth:"Пред. месяц",nextMonth:"След. месяц",months:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],weekdays:["Понедельник","Вторник","Среда","Четверг","Пятница","Суббота","Воскресенье"],weekdaysShort:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"]}}},s=function(e){this.options=e,this.dateSelected={},this.elements={},this.controls={}};return s.prototype.initialize=function(){var s=this,r=this.options.dateValueFormat,i=app.doc.getElementById(n.formElementId),l=this.options.dateFields||[];l.forEach(function(t){var a=app.extend({},n.pikaday),o=i.elements[t.fieldName],l=function(){var e=this.getMoment().format(r);s.dateSelected[t.name]=e,s._onDateChange()};a.onSelect=l,a.field=o,o.value=t.defaultValue.format(s.options.dateDisplayFormat),s.dateSelected[t.name]=t.defaultValue.format(r);var d=new e(a);s.controls[t.name]=d,s.elements[t.name]=o}),t.on("beforeQuery",function(){a.set("идёт загрузка данных","progress"),s.elements.dateFrom.disabled=!0,s.elements.dateTo.disabled=!0}),t.on("afterQuery",function(e){s.elements.dateFrom.disabled=!1,s.elements.dateTo.disabled=!1;var t=o(s.dateSelected.dateFrom,r).diff(o(s.dateSelected.dateTo,r)),n=o.duration(t).humanize();e&&e.features&&e.features.length?a.set("показаны данные за "+n):a.set("нет данных за выбранный период","warning")}),this._onDateChange()},s.prototype._onDateChange=function(){var e=this.options.dateValueFormat,n=this.dateSelected.dateFrom,s=this.dateSelected.dateTo,r=o(n,e).diff(o(s,e)),i=o.duration(r),l=i.months(),d=i.days();d+=30*l,d>=0?(a.set("выбран неверный период","warning"),t.clean()):d<-this.options.maxPeriod?(a.set("выбран слишком большой период","warning"),t.clean()):t.query({starttime:n,endtime:s})},new s(n)}),define("message",[],function(){var e={elementId:"dateSelectorMessage",messageClass:null,elements:{}},t=function(e){this.options=e;var t=e.elementId,a=app.doc.getElementById(t),o=a.querySelectorAll(".message")[0];this.elements={container:a,text:o}};return t.prototype.set=function(e,t){this._resetClass(),this.elements.text.innerHTML=e,t&&(this.elements.container.classList.add(t),this.messageClass=t)},t.prototype.clear=function(){this._resetClass(),this.elements.text.innerHTML=""},t.prototype._resetClass=function(){this.messageClass&&(this.elements.container.classList.remove(this.messageClass),this.messageClass=null)},new t(e)});